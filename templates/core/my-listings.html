{% extends 'partials/base.html' %}
{% load static %}

{% block content %}

<div class="main_content">
    <div class="mcontainer">
        <!-- Item listing  -->
        <div id="rental-items" class="card md:p-6 p-2 max-w-3xl mx-auto">
            <div class="flex justify-between items-center md:mb-4 mb-3">
                <h2 class="text-xl font-bold">My Listings</h2>
            </div>

            <!-- Buttons -->
            <div class="flex space-x-3 mb-5">
                <a href="#offcanvas-add-item" uk-toggle class="flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 hover:text-white">
                    <ion-icon name="add-circle-outline" class="mr-2 text-xl"></ion-icon> Add Items
                </a>
                <a href="{% url 'core:rental-progress' %}" class="flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 hover:text-white">
                    <ion-icon name="stats-chart-outline" class="mr-2 text-xl"></ion-icon> View Rental Progress
                </a>
            </div>

            <!-- Items Grid -->
            {% if products %}
            <div class="grid md:grid-cols-3 sm:grid-cols-2 grid-cols-1 gap-4 mt-6">
                {% for product in products %}
                <div class="card" id="product-card-{{ product.pid }}">
                    <a href="{% url 'core:item-detail' product.slug %}">
                        <img src="{{ product.image.url }}" class="h-48 object-cover rounded-t-md shadow-sm w-full">
                    </a>
                    <div class="p-3">
                        <a href="{% url 'core:item-detail' product.slug %}" class="text-base font-semibold mb-1"> 
                            {{ product.title }}
                        </a>
                        <p class="font-medium text-sm text-gray-600">
                            RM {{ product.daily_rate|floatformat:2 }} / day
                        </p>
                        <a href="#offcanvas-edit-item-{{ product.pid }}" uk-toggle class="bg-blue-100 w-full flex font-semibold h-8 items-center justify-center mt-3 px-3 rounded-md text-blue-600 text-sm mb-1">
                            Edit Details
                        </a>
                    </div>
                </div>

                <!-- Edit Item Offcanvas for each product -->
                <div id="offcanvas-edit-item-{{ product.pid }}" uk-offcanvas="flip: true; overlay: true">
                    <div class="uk-offcanvas-bar lg:w-4/12 w-full dark:bg-gray-700 dark:text-gray-300 p-0 bg-white flex flex-col justify-center">
                        <button class="uk-offcanvas-close absolute" type="button" uk-close></button>

                        <div class="-mb-1 border-b font-semibold px-5 py-5 text-lg">
                            <h4>Edit Item Details</h4>
                        </div>

                        <form action="{% url 'core:edit-item' product.pid %}" method="POST" enctype="multipart/form-data" class="p-6 space-y-3 flex-1 overflow-y-auto">
                            {% csrf_token %}
                            <div>
                                <label class="mb-0"> Title <span class="text-red-500">*</span> </label>
                                <input type="text" name="title" class="with-border" value="{{ product.title }}" required {% if product.status == 'rented' %}disabled{% endif %}>
                            </div>
                            <div>
                                <label class="mb-0"> Description <span class="text-red-500">*</span> </label>
                                <textarea name="description" class="with-border" rows="3" required {% if product.status == 'rented' %}disabled{% endif %}>{{ product.description }}</textarea>
                            </div>
                            <div>
                                <label class="mb-0"> Daily Rate (RM) <span class="text-red-500">*</span> </label>
                                <input type="number" name="daily_rate" class="with-border" value="{{ product.daily_rate|floatformat:2 }}" step="0.01" required {% if product.status == 'rented' %}disabled{% endif %}>
                            </div>
                            <div>
                                <label class="mb-0"> Location <span class="text-red-500">*</span> </label>
                                <input type="text" name="location" class="with-border" value="{{ product.location }}" required {% if product.status == 'rented' %}disabled{% endif %}>
                            </div>
                            {% if product.status == 'rented' %}
                                <div>
                                    <label class="mb-0"> Status </label>
                                    <input type="text" class="with-border bg-gray-100" value="Currently Rented" disabled>
                                    <small class="text-gray-500 mt-1 block">This item is currently rented and cannot be edited until the rental is completed.</small>
                                </div>
                            {% else %}
                                <div>
                                    <label class="mb-0"> Status <span class="text-red-500">*</span> </label>
                                    <select name="status" class="selectpicker with-border">
                                        <option value="available" {% if product.status == 'available' %}selected{% endif %}>Available</option>
                                        <option value="unavailable" {% if product.status == 'unavailable' %}selected{% endif %}>Unavailable</option>
                                    </select>
                                </div>
                            {% endif %}
                            
                            <div uk-form-custom class="w-full py-3">
                                <label class="mb-2 block"> Upload New Item Image </label>
                                <div class="bg-gray-100 border-2 border-dashed flex flex-col h-32 items-center justify-center relative w-full rounded-lg dark:bg-gray-800 dark:border-gray-600 overflow-hidden">
                                    <img id="edit-item-image-preview-{{ product.pid }}" src="{{ product.image.url }}" class="absolute inset-0 w-full h-full object-cover" alt="Preview">
                                </div>
                                <input type="file" name="image" onchange="loadEditItemImage(event, '{{ product.pid }}')" {% if product.status == 'rented' %}disabled{% endif %}>
                            </div>

                            <div class="p-5 grid grid-cols-2 gap-4">
                                <button type="submit" class="button w-full bg-blue-600 text-white" {% if product.status == 'rented' %}disabled{% endif %}>Save Details</button>
                                <a href="#delete-item-confirm-{{ product.pid }}" uk-toggle class="button w-full bg-red-600 text-white text-center" style="background-color: #dc2626 !important;">Delete</a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete Confirmation Modal for each product -->
                <div id="delete-item-confirm-{{ product.pid }}" class="uk-flex-top" uk-modal>
                    <div class="uk-modal-dialog uk-modal-body uk-margin-auto-vertical rounded-lg text-center p-5">
                        <h2 class="text-lg font-bold">Confirm Deletion</h2>
                        <p class="mt-2 text-sm">Are you sure you want to delete this item? This action cannot be undone.</p>
                        <div class="flex justify-center mt-6 space-x-4">
                            <button class="uk-modal-close button bg-gray-200 text-gray-700 cancel-delete-btn" type="button" data-pid="{{ product.pid }}">Cancel</button>
                            <button class="button bg-red-600 text-white delete-item-confirm-btn" data-pid="{{ product.pid }}" type="button" style="background-color: #dc2626 !important;">Confirm</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex justify-center mt-6">
                <p class="text-gray-500">There are no items added</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Item Offcanvas -->
<div id="offcanvas-add-item" uk-offcanvas="flip: true; overlay: true">
    <div class="uk-offcanvas-bar lg:w-4/12 w-full dark:bg-gray-700 dark:text-gray-300 p-0 bg-white flex flex-col justify-center">
        <button class="uk-offcanvas-close absolute" type="button" uk-close></button>

        <!-- header -->
        <div class="-mb-1 border-b font-semibold px-5 py-5 text-lg">
            <h4>Add Item</h4>
        </div>

        <form action="{% url 'core:add-item' %}" method="POST" enctype="multipart/form-data" class="p-6 space-y-3 flex-1 overflow-y-auto">
            {% csrf_token %}
            <div>
                <label class="mb-0"> Title <span class="text-red-500">*</span> </label>
                <input type="text" name="title" class="with-border" placeholder="Item Title" required>
            </div>
            <div>
                <label class="mb-0"> Description <span class="text-red-500">*</span> </label>
                <textarea name="description" class="with-border" rows="3" placeholder="Item Description" required></textarea>
            </div>
            <div>
                <label class="mb-0"> Daily Rate (RM) <span class="text-red-500">*</span> </label>
                <input type="number" name="daily_rate" class="with-border" placeholder="0.00" step="0.01" required>
            </div>
            <div>
                <label class="mb-0"> Location <span class="text-red-500">*</span> </label>
                <input type="text" name="location" class="with-border" placeholder="Location" required>
            </div>
            
            <div uk-form-custom class="w-full py-3">
                <label class="mb-2 block"> Upload Item Image <span class="text-red-500">*</span> </label>
                <div class="bg-gray-100 border-2 border-dashed flex flex-col h-32 items-center justify-center relative w-full rounded-lg dark:bg-gray-800 dark:border-gray-600 overflow-hidden">
                    <div id="item-image-placeholder" class="flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-12 text-gray-400">
                            <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                            <path d="M9 13h2v5a1 1 0 11-2 0v-5z" />
                        </svg>
                    </div>
                    <img id="item-image-preview" src="#" class="absolute inset-0 w-full h-full object-cover hidden" alt="Preview">
                </div>
                <input type="file" name="image" required onchange="loadItemImage(event)">
            </div>

            <div class="p-5">
                <button type="submit" class="button w-full bg-blue-600 text-white">Add Item</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Preview for Add Item
    var loadItemImage = function(event) {
        var output = document.getElementById('item-image-preview');
        var placeholder = document.getElementById('item-image-placeholder');
        
        if (event.target.files && event.target.files[0]) {
            output.src = URL.createObjectURL(event.target.files[0]);
            output.classList.remove('hidden');
            placeholder.classList.add('hidden');
        }
    };

    // Preview for Edit Item
    var loadEditItemImage = function(event, pid) {
        var output = document.getElementById('edit-item-image-preview-' + pid);
        output.src = URL.createObjectURL(event.target.files[0]);
        output.onload = function() {
            URL.revokeObjectURL(output.src) // free memory
        }
    };

    // Handle item deletion cancellation
    $(document).on("click", ".cancel-delete-btn", function () {
        let pid = $(this).data("pid");
        UIkit.offcanvas('#offcanvas-edit-item-' + pid).hide();
    });

    // Handle item deletion confirmation
    $(document).on("click", ".delete-item-confirm-btn", function () {
        let pid = $(this).attr("data-pid");
        let delete_url = `/delete-item/${pid}/`;

        $.ajax({
            url: delete_url,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            dataType: "json",
            success: function(res){
                if(res.status === 'success'){
                    UIkit.notification({
                        message: '<span class="text-sm">Item deleted successfully</span>',
                        status: 'success',
                        pos: 'top-right',
                        timeout: 2000
                    });
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    UIkit.notification({ message: res.message || 'An error occurred.', status: 'danger', pos: 'top-right', timeout: 5000 });
                }
            },
            error: function(err) {
                console.log(err);
                UIkit.notification({ message: 'A server error occurred. Please try again.', status: 'danger', pos: 'top-right', timeout: 5000 });
            }
        });
    });
</script>

{% endblock %}